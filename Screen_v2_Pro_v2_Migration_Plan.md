# PsycheOS Screen v2 + Pro v2 ‚Äî –ü–ª–∞–Ω –º–∏–≥—Ä–∞—Ü–∏–∏

## –°—Ç–∞—Ç—É—Å: Phase 4 completion (Screen v2 ‚Üí Pro v2)

---

## 1. –û–±–∑–æ—Ä: –ß—Ç–æ –º–∏–≥—Ä–∏—Ä—É–µ–º –∏ —á—Ç–æ –ø–µ—Ä–µ–¥–µ–ª—ã–≤–∞–µ–º

### Screen v2 ‚Äî –ü–ï–†–ï–î–ï–õ–ö–ê (–Ω–µ –ø—Ä–æ—Å—Ç–∞—è –º–∏–≥—Ä–∞—Ü–∏—è)
Legacy Screen –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **—Å—Ç–∞—Ä—É—é –º–æ–¥–µ–ª—å** (4 –∫–æ–Ω—Ç–∏–Ω—É—É–º–∞: economy_exploration, protection_contact, retention_movement, survival_development) –∏ 25 —ç–∫—Ä–∞–Ω–æ–≤ –≤ 5 –±–ª–æ–∫–∞—Ö.

**Screen v2 –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç:
- **4 –Ω–æ–≤—ã–µ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–∏**: A1 (–ê–∫—Ç–∏–≤–∞—Ü–∏—è), A2 (–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç—å), A3 (–ò–º–ø—É–ª—å—Å), A4 (–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è)
- **5 —Å–ª–æ—ë–≤**: L0‚ÄìL4 (—ç–Ω–µ—Ä–≥–µ—Ç–∏—á–µ—Å–∫–∏–π ‚Üí –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—ã–π)
- **3 —Ñ–∞–∑—ã**: 6 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ ‚Üí –¥–æ 3 —É—Ç–æ—á–Ω–µ–Ω–∏–π ‚Üí –¥–æ 5 –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö
- **–í–µ–∫—Ç–æ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å** —Å weight matrices –≤–º–µ—Å—Ç–æ –ø—Ä–æ—Å—Ç–æ–≥–æ —Å—Ä–µ–¥–Ω–µ–≤–∑–≤–µ—à–µ–Ω–Ω–æ–≥–æ
- **4 –æ—Ç–¥–µ–ª—å–Ω—ã—Ö Claude –ø—Ä–æ–º–ø—Ç–∞** –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ

### Pro v2 ‚Äî –†–ê–°–®–ò–†–ï–ù–ò–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ Pro
–¢–µ–∫—É—â–∏–π Pro —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (cases, invites, links). –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- –°–æ–∑–¥–∞–Ω–∏–µ screening-—Å–µ—Å—Å–∏–∏ (assessment)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞ (JSON + DOCX)
- –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞ —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞

---

## 2. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–ø—Ä–∏–Ω—è—Ç—å –î–û –Ω–∞—á–∞–ª–∞ –∫–æ–¥–∞)

### 2.1. –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö Screen v2

**–ù–ï –ø–µ—Ä–µ–Ω–æ—Å–∏–º** –∏–∑ legacy: `Specialist`, `Transaction`, `ScreeningSession`, `ScreeningOutput`.

**–ò–°–ü–û–õ–¨–ó–£–ï–ú** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ production –º–æ–¥–µ–ª–∏:
- `User` ‚Üí –≤–º–µ—Å—Ç–æ `Specialist`
- `Context` ‚Üí –∫–µ–π—Å, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –ø—Ä–∏–≤—è–∑–∞–Ω —Å–∫—Ä–∏–Ω–∏–Ω–≥
- `BotChatState` ‚Üí FSM + session payload –¥–ª—è Screen –±–æ—Ç–∞
- `LinkToken` ‚Üí —Å—Å—ã–ª–∫–∞ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞

**–°–û–ó–î–ê–Å–ú –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É**: `screening_assessment`
```sql
CREATE TABLE screening_assessment (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    context_id UUID NOT NULL REFERENCES context(id),
    specialist_user_id BIGINT NOT NULL,
    client_chat_id BIGINT,           -- –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    status VARCHAR(20) DEFAULT 'created',  -- created/in_progress/completed/expired
    
    -- –§–∞–∑–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
    phase INTEGER DEFAULT 0,          -- 0/1/2/3
    phase1_completed BOOLEAN DEFAULT FALSE,
    phase2_questions INTEGER DEFAULT 0,
    phase3_questions INTEGER DEFAULT 0,
    
    -- –í–µ–∫—Ç–æ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å (—Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã)
    axis_vector JSONB DEFAULT '{}',   -- {A1: float, A2: float, A3: float, A4: float}
    layer_vector JSONB DEFAULT '{}',  -- {L0: float, L1: float, L2: float, L3: float, L4: float}
    tension_matrix JSONB DEFAULT '{}', -- M[Lk, Aj] = 5x4 matrix
    rigidity JSONB DEFAULT '{}',      -- {polarization, low_variance, strategy_repetition, total}
    confidence FLOAT DEFAULT 0.0,
    ambiguity_zones JSONB DEFAULT '[]',
    dominant_cells JSONB DEFAULT '[]',
    
    -- –ü–æ–ª–Ω—ã–π –ª–æ–≥ –æ—Ç–≤–µ—Ç–æ–≤
    response_history JSONB DEFAULT '[]',
    -- –ö–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç: {screen_id, phase, question_text, selected_options, axis_contributions, layer_contributions, timestamp}
    
    -- –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
    report_json JSONB,               -- –ø–æ–ª–Ω—ã–π JSON –æ—Ç—á—ë—Ç
    report_text TEXT,                 -- —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç
    
    -- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    created_at TIMESTAMPTZ DEFAULT NOW(),
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    expires_at TIMESTAMPTZ,
    link_token_jti UUID REFERENCES link_token(jti)
);
```

### 2.2. –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ Screen v2

```
app/services/screen/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ engine.py              # –í–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫: –∞–≥—Ä–µ–≥–∞—Ü–∏—è, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, –º–∞—Ç—Ä–∏—Ü–∞, —Ä–∏–≥–∏–¥–Ω–æ—Å—Ç—å, confidence
‚îú‚îÄ‚îÄ screen_bank.py         # 6 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ Phase 1 + 20 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—à–∞–±–ª–æ–Ω–æ–≤ Phase 2/3
‚îú‚îÄ‚îÄ weight_matrix.py       # –í–µ—Å–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ (–∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
‚îú‚îÄ‚îÄ prompts.py             # 5 Claude –ø—Ä–æ–º–ø—Ç–æ–≤: Router, Constructor, ReportGenerator, SessionBridge, StopDecision
‚îú‚îÄ‚îÄ orchestrator.py        # –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ñ–∞–∑: Phase1 (rule-based) ‚Üí Phase2 (Claude Router) ‚Üí Phase3 (Claude Constructor)
‚îî‚îÄ‚îÄ report.py              # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ (JSON + TXT + DOCX)

app/webhooks/screen.py     # Webhook handler (–∑–∞–º–µ–Ω—è–µ—Ç stubs.py)
```

### 2.3. FSM Screen –±–æ—Ç–∞

```
idle ‚Üí active ‚Üí phase1 ‚Üí [phase2] ‚Üí [phase3] ‚Üí report ‚Üí completed
```

–°–æ—Å—Ç–æ—è–Ω–∏—è –≤ `BotChatState.state`:
- `idle` ‚Äî –¥–æ —Å—Ç–∞—Ä—Ç–∞
- `active` ‚Äî –∫–ª–∏–µ–Ω—Ç –ø–µ—Ä–µ—à—ë–ª –ø–æ —Å—Å—ã–ª–∫–µ, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
- `phase1_q{1-6}` ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
- `phase2_q{1-3}` ‚Äî —É—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `phase3_q{1-5}` ‚Äî –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- `completed` ‚Äî —Å–∫—Ä–∏–Ω–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω

`BotChatState.state_payload["session"]`:
```json
{
    "assessment_id": "uuid",
    "phase": 1,
    "current_screen": {...},
    "screens_shown": 3,
    "selected_options": []
}
```

### 2.4. –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö Screen v2

```
1. Pro: specialist —Å–æ–∑–¥–∞—ë—Ç assessment ‚Üí screening_assessment(status=created)
2. Pro: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç link_token(role=client, service=screen) ‚Üí deep link
3. Client: /start {jti} ‚Üí verify_link ‚Üí screening_assessment(status=in_progress)
4. Client: Phase 1 ‚Äî 6 —ç–∫—Ä–∞–Ω–æ–≤ multi-select ‚Üí engine.py –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç –≤–µ–∫—Ç–æ—Ä
5. Client: Phase 2 ‚Äî Claude Router –≤—ã–±–∏—Ä–∞–µ—Ç ambiguity zone ‚Üí Constructor –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å
6. Client: Phase 3 ‚Äî –µ—Å–ª–∏ confidence < 0.85 –ø–æ—Å–ª–µ Phase 2
7. System: Report Generator ‚Üí JSON + TXT ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–ª–∏–µ–Ω—Ç—É "—Å–ø–∞—Å–∏–±–æ"
8. System: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Pro ‚Üí specialist –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç—á—ë—Ç
```

---

## 3. –ü–æ—Ä—è–¥–æ–∫ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (—à–∞–≥–∏ –¥–ª—è Claude Code)

### –®–∞–≥ 1: –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î ‚Äî screening_assessment
- –°–æ–∑–¥–∞—Ç—å `app/models/screening_assessment.py`
- –°–æ–∑–¥–∞—Ç—å Alembic –º–∏–≥—Ä–∞—Ü–∏—é
- –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –®–∞–≥ 2: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫ (engine.py + weight_matrix.py)
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∞–≥—Ä–µ–≥–∞—Ü–∏—é AxisScore, LayerScore
- –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è tanh()
- –ú–∞—Ç—Ä–∏—Ü–∞ –Ω–∞–ø—Ä—è–∂–µ–Ω–∏—è M[k,j]
- –ò–Ω–¥–µ–∫—Å —Ä–∏–≥–∏–¥–Ω–æ—Å—Ç–∏
- –†–∞—Å—á—ë—Ç confidence
- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ambiguity zones
- **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã** —Å —Ç–µ—Å—Ç–æ–≤—ã–º –∫–µ–π—Å–æ–º –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏

### –®–∞–≥ 3: –ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ (screen_bank.py + weight_matrix.py)
- 6 —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ Phase 1 —Å –≤–µ—Å–∞–º–∏ –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- 20 —Ä–µ—Ñ–µ—Ä–µ–Ω—Å-—à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è Phase 2/3
- –§–æ—Ä–º–∞—Ç –≤–æ–ø—Ä–æ—Å–∞: text, options[], weights per option (axis_vector + layer_vector)

### –®–∞–≥ 4: Claude –ø—Ä–æ–º–ø—Ç—ã (prompts.py)
- PHASE2_ROUTER_PROMPT
- PHASE3_CONSTRUCTOR_PROMPT
- REPORT_GENERATOR_PROMPT
- FIRST_SESSION_BRIDGE_PROMPT
- PHASE2_STOP_DECISION_PROMPT

### –®–∞–≥ 5: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ñ–∞–∑ (orchestrator.py)
- Phase 1: rule-based, –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ 6 —ç–∫—Ä–∞–Ω–æ–≤ ‚Üí engine.aggregate()
- Phase 2: Claude Router ‚Üí –≤—ã–±–æ—Ä —É–∑–ª–∞ ‚Üí Claude Constructor ‚Üí engine.update()
- Phase 3: –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Phase 2, –Ω–æ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º –ø—É–ª–æ–º
- Stopping criteria: |ŒîAxis| < 0.1, Confidence ‚â• 0.85, max questions
- –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è ‚Üí report generation

### –®–∞–≥ 6: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–∞ (report.py)
- JSON-–æ—Ç—á—ë—Ç (–ø–æ–ª–Ω—ã–π machine-readable)
- TXT-–æ—Ç—á—ë—Ç (—á–∏—Ç–∞–µ–º—ã–π)
- DOCX-–æ—Ç—á—ë—Ç (–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–ª—è —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏: Axis Profile, Dominant Layers, Top L√óA, Rigidity, Confidence, Explanation, How to Read, Interview Protocol

### –®–∞–≥ 7: Webhook handler (screen.py)
- `/start {jti}` ‚Üí verify_link ‚Üí load assessment ‚Üí show welcome
- –û–±—Ä–∞–±–æ—Ç–∫–∞ multi-select –æ—Ç–≤–µ—Ç–æ–≤ (callback_query)
- FSM –ø–µ—Ä–µ—Ö–æ–¥—ã phase1 ‚Üí phase2 ‚Üí phase3 ‚Üí completed
- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ –∫–ª–∏–µ–Ω—Ç—É ("–°–ø–∞—Å–∏–±–æ")
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Pro –±–æ—Ç–∞

### –®–∞–≥ 8: Pro v2 ‚Äî —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ (webhooks/pro.py)
- –ù–æ–≤—ã–π callback: `screen_link_{context_id}` ‚Üí —Å–æ–∑–¥–∞—Ç—å assessment + issue_link
- –ù–æ–≤—ã–π callback: `screen_results_{context_id}` ‚Üí –ø–æ–ª—É—á–∏—Ç—å –æ—Ç—á—ë—Ç
- –ù–æ–≤—ã–π callback: `screen_status_{context_id}` ‚Üí —Å—Ç–∞—Ç—É—Å —Å–∫—Ä–∏–Ω–∏–Ω–≥–∞
- –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞ –∫–∞–∫ .json + .docx –¥–æ–∫—É–º–µ–Ω—Ç—ã

### –®–∞–≥ 9: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- set_webhooks.py ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Screen webhook –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- E2E —Ç–µ—Å—Ç: Pro —Å–æ–∑–¥–∞—ë—Ç ‚Üí Client –ø—Ä–æ—Ö–æ–¥–∏—Ç ‚Üí Pro –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç—á—ë—Ç
- –î–µ–ø–ª–æ–π –Ω–∞ Railway

---

## 4. –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è (–ù–ï –ú–ï–ù–Ø–¢–¨)

1. **–í–µ–∫—Ç–æ—Ä–Ω–∞—è –º–æ–¥–µ–ª—å** ‚Äî 4 –æ—Å–∏ √ó 5 —Å–ª–æ—ë–≤, tanh –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è, –º–∞—Ç—Ä–∏—Ü–∞ M[k,j]
2. **3-—Ñ–∞–∑–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** ‚Äî 6 fixed + 3 adaptive + 5 constructor
3. **Claude –ø—Ä–æ–º–ø—Ç—ã —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ** ‚Äî Router, Constructor, Report, Bridge, Stop
4. **Confidence threshold** = 0.85
5. **Max Phase 2 questions** = 3
6. **Max Phase 3 questions** = 5
7. **–ú–æ–¥–µ–ª—å Claude** ‚Äî claude-haiku-4-5 –¥–ª—è Router/Stop, claude-sonnet-4-5 –¥–ª—è Report/Constructor
8. **–í–µ—Å–æ–≤–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω** ‚Äî {-0.8, -0.5, -0.3, 0, +0.3, +0.5, +0.8}
9. **Rigidity** = Œ±¬∑Polarization + Œ≤¬∑LowVariance + Œ≥¬∑StrategyRepetition (Œ±=0.3, Œ≤=0.3, Œ≥=0.4)

---

## 5. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è Claude Code (–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ —à–∞–≥–∞–º)

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 1 (–®–∞–≥ 1: –ú–æ–¥–µ–ª—å –ë–î)

```
–°–æ–∑–¥–∞–π –º–æ–¥–µ–ª—å screening_assessment –¥–ª—è Screen v2. 

–§–∞–π–ª: app/models/screening_assessment.py

–ú–æ–¥–µ–ª—å SQLAlchemy (async, –∫–∞–∫ bot_chat_state.py):
- id: UUID, PK, server_default=gen_random_uuid()
- context_id: UUID, FK ‚Üí context.id, NOT NULL
- specialist_user_id: BigInteger, NOT NULL
- client_chat_id: BigInteger, nullable
- status: String(20), default="created" (created/in_progress/completed/expired)
- phase: Integer, default=0
- phase1_completed: Boolean, default=False
- phase2_questions: Integer, default=0
- phase3_questions: Integer, default=0
- axis_vector: JSONB, default={}
- layer_vector: JSONB, default={}
- tension_matrix: JSONB, default={}
- rigidity: JSONB, default={}
- confidence: Float, default=0.0
- ambiguity_zones: JSONB, default=[]
- dominant_cells: JSONB, default=[]
- response_history: JSONB, default=[]
- report_json: JSONB, nullable
- report_text: Text, nullable
- created_at, started_at, completed_at, expires_at: DateTime(timezone=True)
- link_token_jti: UUID, FK ‚Üí link_token.jti, nullable

Index –Ω–∞ context_id –∏ status.

–ó–∞—Ç–µ–º —Å–æ–∑–¥–∞–π Alembic –º–∏–≥—Ä–∞—Ü–∏—é: alembic/versions/0002_create_screening_assessment.py

–ü–∞—Ç—Ç–µ—Ä–Ω ‚Äî –∫–∞–∫ –≤ 0001_create_link_tokens.py.

–û–±–Ω–æ–≤–∏ CLAUDE.md: –¥–æ–±–∞–≤—å screening_assessment –≤ —Ä–∞–∑–¥–µ–ª –º–æ–¥–µ–ª–µ–π –∏ –æ—Ç–º–µ—Ç—å Phase 4 Screen v2 ‚Äî Step 1 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 2 (–®–∞–≥ 2: –í–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫)

```
–°–æ–∑–¥–∞–π –≤–µ–∫—Ç–æ—Ä–Ω—ã–π –¥–≤–∏–∂–æ–∫ Screen v2.

–§–∞–π–ª: app/services/screen/__init__.py (–ø—É—Å—Ç–æ–π)
–§–∞–π–ª: app/services/screen/engine.py

–ö–ª–∞—Å—Å ScreeningEngine:

1. aggregate_vectors(responses: list[dict]) -> tuple[dict, dict]
   - –ö–∞–∂–¥—ã–π response: {axis_weights: {A1: float, ...}, layer_weights: {L0: float, ...}}
   - AxisScore_j = sum(weights_j) / N
   - LayerScore_k = sum(weights_k) / N
   - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: tanh(score)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (axis_vector, layer_vector)

2. compute_tension_matrix(axis_vector, layer_vector) -> dict
   - M[Lk, Aj] = LayerScore_k * AxisScore_j
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {f"L{k}_A{j}": value}

3. compute_rigidity(responses, axis_vector) -> dict
   - polarization: –¥–æ–ª—è |AxisScore_j| > 0.7
   - low_variance: —Å—Ä–µ–¥–Ω—è—è –¥–∏—Å–ø–µ—Ä—Å–∏—è –≤–Ω—É—Ç—Ä–∏ –∫–∞–∂–¥–æ–π –æ—Å–∏ (< 0.15 = rigid)
   - strategy_repetition: –¥–æ–ª—è –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
   - total: 0.3*pol + 0.3*var + 0.4*rep
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {polarization, low_variance, strategy_repetition, total}

4. compute_confidence(responses, axis_vector, ambiguity_count) -> float
   - –ë–∞–∑–æ–≤–∞—è: 1 - uncertainty_index
   - uncertainty_index = f(–¥–∏—Å–ø–µ—Ä—Å–∏—è, –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ –≤–∫–ª–∞–¥—ã, –º–∞–ª–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞)
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0.0-1.0

5. find_ambiguity_zones(axis_vector, layer_vector, tension_matrix, confidence) -> list[str]
   - –Ø—á–µ–π–∫–∏ —Å |conflict| > threshold –∏–ª–∏ low amplitude
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ["A2_L4", "A1_L0", ...]

6. get_dominant_cells(tension_matrix, top_n=3) -> list[str]
   - Top N —è—á–µ–µ–∫ –ø–æ –∞–±—Å–æ–ª—é—Ç–Ω–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ["L4_A2", "L2_A4", "L0_A1"]

7. process_response(current_state: dict, new_response: dict) -> dict
   - –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç –≤ response_history
   - –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π state

–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç (—Ç–µ—Å—Ç–æ–≤—ã–π –∫–µ–π—Å –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏):
–í—Ö–æ–¥–Ω—ã–µ 14 –æ—Ç–≤–µ—Ç–æ–≤ ‚Üí –æ–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
A1 ‚âà -0.62, A2 ‚âà -0.68, A3 ‚âà +0.41, A4 ‚âà -0.73
L0 ‚âà +0.72, L1 ‚âà -0.18, L2 ‚âà +0.65, L3 ‚âà -0.44, L4 ‚âà +0.81
Confidence ‚âà 0.66

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 2 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 3 (–®–∞–≥ 3: –ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤)

```
–°–æ–∑–¥–∞–π –±–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ Screen v2.

–§–∞–π–ª: app/services/screen/screen_bank.py
–§–∞–π–ª: app/services/screen/weight_matrix.py

–í weight_matrix.py ‚Äî –≤–µ—Å–æ–≤—ã–µ –≤–µ–∫—Ç–æ—Ä–∞ –¥–ª—è –ö–ê–ñ–î–û–ì–û –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞:

PHASE1_WEIGHTS ‚Äî 6 —ç–∫—Ä–∞–Ω–æ–≤, –∫–∞–∂–¥—ã–π —ç–∫—Ä–∞–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –≤–µ—Å–∞–º–∏.

–§–æ—Ä–º–∞—Ç:
PHASE1_SCREENS = [
    {
        "screen_id": "P1_01",
        "question": "–ö–æ–≥–¥–∞ –≤—ã —É—Å—Ç–∞–ª–∏, –Ω–æ –ø—Ä–∏ —ç—Ç–æ–º –µ—Å—Ç—å –≤–∞–∂–Ω–æ–µ –¥–µ–ª–æ, —á—Ç–æ –∏–∑ —ç—Ç–æ–≥–æ —á–∞—â–µ –≤—Å–µ–≥–æ —Å –≤–∞–º–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?",
        "type": "multi_select",
        "options": [
            {
                "text": "–Ø –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞—á–∏–Ω–∞—é –¥–µ–ª–∞—Ç—å, –¥–∞–∂–µ —á–µ—Ä–µ–∑ —Å–∏–ª—É",
                "axis_weights": {"A1": 0.5, "A3": 0.3, "A4": 0.4},
                "layer_weights": {"L0": 0.3, "L1": 0.6, "L2": 0.2}
            },
            ...–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö 6 —ç–∫—Ä–∞–Ω–æ–≤...
        ]
    },
    ...
]

PHASE2_TEMPLATES ‚Äî 20 —É–∑–ª–æ–≤ (A1√óL0 ... A4√óL4), –∫–∞–∂–¥—ã–π:
{
    "node": "A1_L0",
    "diagnostic_split": "–ø–µ—Ä–≤–∏—á–Ω–∞—è —É—Å—Ç–∞–ª–æ—Å—Ç—å vs —É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–Ω–∏–∂–µ–Ω–Ω—ã–π —Ç–æ–Ω—É—Å",
    "reference_question": "–ö–æ–≥–¥–∞ —É –≤–∞—Å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è...",
    "options": [...—Å weights –∏ split_logic...],
    "split_logic": {"H1_supported_by": [...], "H2_supported_by": [...]}
}

–í—Å–µ 20 —É–∑–ª–æ–≤ —Å–æ –≤—Å–µ–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ –∏ –≤–µ—Å–∞–º–∏ ‚Äî –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.

–í—Å–µ —Ç–µ–∫—Å—Ç—ã –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.

–í screen_bank.py:
- get_phase1_screen(index: int) -> dict
- get_phase2_template(node: str) -> dict
- get_all_phase2_nodes() -> list[str]

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 3 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 4 (–®–∞–≥ 4: Claude –ø—Ä–æ–º–ø—Ç—ã)

```
–°–æ–∑–¥–∞–π Claude –ø—Ä–æ–º–ø—Ç—ã –¥–ª—è Screen v2.

–§–∞–π–ª: app/services/screen/prompts.py

5 –ø—Ä–æ–º–ø—Ç–æ–≤ (–≤—Å–µ –Ω–∞ –ê–ù–ì–õ–ò–ô–°–ö–û–ú –¥–ª—è Claude, –Ω–æ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ-—Ä—É—Å—Å–∫–∏ –≥–¥–µ –Ω—É–∂–Ω–æ):

1. PHASE2_ROUTER_PROMPT ‚Äî –≤—ã–±–æ—Ä ambiguity-–∑–æ–Ω—ã
   Input: AxisVector, LayerVector, RigidityIndex, AmbiguityZones, Confidence
   Output: JSON {selected_node, reason}
   
2. PHASE3_CONSTRUCTOR_PROMPT ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ç–æ—á–Ω—è—é—â–µ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
   Input: diagnostic node, split goal, available templates
   Output: JSON {question, options, split_logic}
   –í–æ–ø—Ä–æ—Å –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –î–û–õ–ñ–ù–´ –±—ã—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º.
   
3. REPORT_GENERATOR_PROMPT ‚Äî —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
   Input: –≤—Å–µ –≤–µ–∫—Ç–æ—Ä–∞, –º–∞—Ç—Ä–∏—Ü–∞, —Ä–∏–≥–∏–¥–Ω–æ—Å—Ç—å, confidence
   Output: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ù–ê –†–£–°–°–ö–û–ú
   –ë–µ–∑ –¥–∏–∞–≥–Ω–æ–∑–æ–≤, –±–µ–∑ —Å–æ–≤–µ—Ç–æ–≤, —Ç–æ–ª—å–∫–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ä–µ–≥—É–ª—è—Ü–∏–∏.
   
4. FIRST_SESSION_BRIDGE_PROMPT ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª –∏–Ω—Ç–µ—Ä–≤—å—é
   Input: structural profile
   Output: JSON {axis_verification, layer_exploration, functional_context} ‚Äî –ù–ê –†–£–°–°–ö–û–ú
   
5. PHASE2_STOP_DECISION_PROMPT ‚Äî —Ä–µ—à–µ–Ω–∏–µ –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
   Input: previous/updated vectors, conflict, confidence, questions_asked
   Output: JSON {stop_phase2: bool, reason}

–§—É–Ω–∫—Ü–∏—è assemble_prompt(prompt_type: str, context: dict) -> str

–ü—Ä–æ–º–ø—Ç—ã –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Ä–∞–∑–¥–µ–ª "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ò–ò"). –î–æ–±–∞–≤—å temperature/top_p —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö.

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 4 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 5 (–®–∞–≥ 5: –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä)

```
–°–æ–∑–¥–∞–π –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Ñ–∞–∑ Screen v2.

–§–∞–π–ª: app/services/screen/orchestrator.py

–ö–ª–∞—Å—Å ScreenOrchestrator:

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏: ScreeningEngine, screen_bank, prompts, anthropic.AsyncAnthropic

1. async start_assessment(assessment_id) -> dict
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–µ—Ä–≤—ã–π —ç–∫—Ä–∞–Ω Phase 1
   
2. async process_phase1_response(assessment_id, screen_index, selected_options) -> dict
   - –î–æ–±–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç —Å –≤–µ—Å–∞–º–∏ —á–µ—Ä–µ–∑ engine.process_response()
   - –ï—Å–ª–∏ screen_index < 6 ‚Üí –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —ç–∫—Ä–∞–Ω
   - –ï—Å–ª–∏ screen_index == 6 ‚Üí –≤—ã—á–∏—Å–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç confidence
     - –ï—Å–ª–∏ confidence ‚â• 0.85 ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ç—á—ë—Ç—É
     - –ò–Ω–∞—á–µ ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ Phase 2

3. async process_phase2_response(assessment_id, selected_options) -> dict
   - –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ–∫—Ç–æ—Ä
   - –í—ã–∑—ã–≤–∞–µ—Ç STOP_DECISION —á–µ—Ä–µ–∑ Claude
   - –ï—Å–ª–∏ stop ‚Üí –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ—Ç—á—ë—Ç—É
   - –ï—Å–ª–∏ continue ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç ROUTER ‚Üí –≤—ã–±–∏—Ä–∞–µ—Ç —É–∑–µ–ª ‚Üí CONSTRUCTOR ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–æ–ø—Ä–æ—Å
   - –ï—Å–ª–∏ phase2_questions >= 3 –∏ confidence < 0.85 ‚Üí Phase 3

4. async process_phase3_response(assessment_id, selected_options) -> dict
   - –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ Phase 2, –Ω–æ max 5 –≤–æ–ø—Ä–æ—Å–æ–≤
   - –í—Å–µ–≥–¥–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –æ—Ç—á—ë—Ç–æ–º

5. async generate_report(assessment_id) -> dict
   - REPORT_GENERATOR —á–µ—Ä–µ–∑ Claude
   - FIRST_SESSION_BRIDGE —á–µ—Ä–µ–∑ Claude
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ screening_assessment.report_json –∏ report_text
   - –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç {report_json, report_text}

–í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î —á–µ—Ä–µ–∑ AsyncSession.
–í—Å–µ Claude –≤—ã–∑–æ–≤—ã —á–µ—Ä–µ–∑ anthropic.AsyncAnthropic —Å settings.ANTHROPIC_API_KEY.
Router/Stop ‚Üí claude-haiku-4-5, Constructor/Report/Bridge ‚Üí claude-sonnet-4-5.

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 5 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 6 (–®–∞–≥ 6: –û—Ç—á—ë—Ç)

```
–°–æ–∑–¥–∞–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á—ë—Ç–æ–≤ Screen v2.

–§–∞–π–ª: app/services/screen/report.py

1. format_report_json(assessment) -> dict
   –ü–æ–ª–Ω—ã–π JSON —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏ –∏–∑ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏:
   assessment_id, timestamp, axis_vector, layer_vector, dominant_cells,
   rigidity, confidence, phases, report_text

2. format_report_txt(assessment, report_data) -> str
   –ß–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –æ—Ç—á—ë—Ç –Ω–∞ –†–£–°–°–ö–û–ú:
   - –ö—Ä–∞—Ç–∫–∏–π –ø—Ä–æ—Ñ–∏–ª—å –æ—Å–µ–π
   - –î–æ–º–∏–Ω–∏—Ä—É—é—â–∏–µ —Å–ª–æ–∏
   - –¢–æ–ø L√óA —Å–æ—á–µ—Ç–∞–Ω–∏—è
   - –ò–Ω–¥–µ–∫—Å –≥–∏–±–∫–æ—Å—Ç–∏
   - –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å
   - –ü–æ—è—Å–Ω–µ–Ω–∏–µ (–∏–∑ Claude)
   - –ö–∞–∫ —á–∏—Ç–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å (—à–∞–±–ª–æ–Ω)
   - –û—Ä–∏–µ–Ω—Ç–∏—Ä—ã –¥–ª—è –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏ (–∏–∑ Claude)

3. async generate_report_docx(report_data) -> bytes
   –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π DOCX-–¥–æ–∫—É–º–µ–Ω—Ç (–∏—Å–ø–æ–ª—å–∑—É—è python-docx):
   - –ó–∞–≥–æ–ª–æ–≤–æ–∫: "PsycheOS Screening v2 ‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å"
   - –î–∞—Ç–∞, Assessment ID
   - –¢–∞–±–ª–∏—Ü–∞ –æ—Å–µ–π (4 —Å—Ç—Ä–æ–∫–∏)
   - –¢–∞–±–ª–∏—Ü–∞ —Å–ª–æ—ë–≤ (5 —Å—Ç—Ä–æ–∫)
   - –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–ø-—Å–æ—á–µ—Ç–∞–Ω–∏–π
   - –ò–Ω–¥–µ–∫—Å –≥–∏–±–∫–æ—Å—Ç–∏
   - –ü–æ—è—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
   - –ü—Ä–æ—Ç–æ–∫–æ–ª –ø–µ—Ä–≤–æ–π —Å–µ—Å—Å–∏–∏
   –®—Ä–∏—Ñ—Ç: Arial, –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∂–∏—Ä–Ω—ã–µ, —Ç–∞–±–ª–∏—Ü—ã —Å —Ä–∞–º–∫–∞–º–∏.

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 6 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 7 (–®–∞–≥ 7: Webhook Screen)

```
–°–æ–∑–¥–∞–π webhook handler –¥–ª—è Screen v2 –±–æ—Ç–∞.

–§–∞–π–ª: app/webhooks/screen.py (–∑–∞–º–µ–Ω—è–µ—Ç –ª–æ–≥–∏–∫—É –∏–∑ stubs.py –¥–ª—è screen)

–§—É–Ω–∫—Ü–∏—è: async handle_screen(update, bot, db, state, chat_id, user_id)

–ü–∞—Ç—Ç–µ—Ä–Ω ‚Äî –∫–∞–∫ –≤ interpretator.py, –Ω–æ —Å multi-select –ª–æ–≥–∏–∫–æ–π.

FSM:
- state=None –∏–ª–∏ "idle": 
  /start {jti} ‚Üí verify_link ‚Üí load screening_assessment ‚Üí 
  upsert_chat_state(state="active", payload={assessment_id}) ‚Üí 
  –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫—É "–ù–∞—á–∞—Ç—å"

- state="active":
  callback "start_screening" ‚Üí 
  upsert_chat_state(state="phase1_q1") ‚Üí 
  –ø–æ–∫–∞–∑–∞—Ç—å –ø–µ—Ä–≤—ã–π —ç–∫—Ä–∞–Ω (multi-select –∏–∑ screen_bank)

- state="phase1_q{N}":
  callback "multi:{screen_id}:{idx}" ‚Üí toggle —á–µ–∫–±–æ–∫—Å –≤ payload
  callback "multi_done:{screen_id}" ‚Üí 
    orchestrator.process_phase1_response() ‚Üí
    –µ—Å–ª–∏ –µ—Å—Ç—å next_screen ‚Üí upsert_chat_state(state=f"phase1_q{N+1}") ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω
    –µ—Å–ª–∏ Phase 2 ‚Üí upsert_chat_state(state="phase2_q1") ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –≤–æ–ø—Ä–æ—Å
    –µ—Å–ª–∏ –æ—Ç—á—ë—Ç ‚Üí generate_report ‚Üí upsert_chat_state(state="completed")

- state="phase2_q{N}" –∏ "phase3_q{N}":
  –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ phase1, –Ω–æ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç Claude

- state="completed":
  –ø–æ–∫–∞–∑–∞—Ç—å "–°–ø–∞—Å–∏–±–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É"
  –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Pro –±–æ—Ç—É

–ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ multi-select: InlineKeyboardMarkup —Å toggle-—á–µ–∫–±–æ–∫—Å–∞–º–∏ [‚úì]/[ ] + –∫–Ω–æ–ø–∫–∞ "–ì–æ—Ç–æ–≤–æ ‚úì"

–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ Pro: —á–µ—Ä–µ–∑ python-telegram-bot Bot(token=settings.TG_TOKEN_PRO).send_message()

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 7 done.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 8 (–®–∞–≥ 8: Pro v2)

```
–†–∞—Å—à–∏—Ä—å Pro –±–æ—Ç –¥–ª—è Screen v2.

–§–∞–π–ª: app/webhooks/pro.py ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥

–ù–æ–≤—ã–µ callbacks:

1. screen_link_{context_id}:
   - –°–æ–∑–¥–∞—Ç—å screening_assessment(context_id, specialist_user_id, expires_at=+48h)
   - issue_link(role="client", service="screen", subject_id=0)
   - –û—Ç–ø—Ä–∞–≤–∏—Ç—å deep link –∫–ª–∏–µ–Ω—Ç—É
   
2. screen_status_{context_id}:
   - SELECT screening_assessment WHERE context_id
   - –ü–æ–∫–∞–∑–∞—Ç—å: status, phase, confidence, created_at
   
3. screen_results_{context_id}:
   - –ï—Å–ª–∏ assessment.status == "completed":
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å report.json –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
     - –û—Ç–ø—Ä–∞–≤–∏—Ç—å report.docx –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
     - –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏
   - –ò–Ω–∞—á–µ: "–°–∫—Ä–∏–Ω–∏–Ω–≥ –µ—â—ë –Ω–µ –∑–∞–≤–µ—Ä—à—ë–Ω"

4. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç Screen –±–æ—Ç–∞:
   - –ö–æ–≥–¥–∞ —Å–∫—Ä–∏–Ω–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω ‚Üí Pro –ø–æ–ª—É—á–∞–µ—Ç inline-–∫–Ω–æ–ø–∫—É "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã"

–ö–Ω–æ–ø–∫–∏ –≤ –º–µ–Ω—é –∫–µ–π—Å–∞ (case_{context_id}):
- –î–æ–±–∞–≤–∏—Ç—å: "üìä –°–∫—Ä–∏–Ω–∏–Ω–≥" ‚Üí screen_menu_{context_id}
- screen_menu: "–°–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É" / "–°—Ç–∞—Ç—É—Å" / "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã" / "–ù–∞–∑–∞–¥"

–û–±–Ω–æ–≤–∏ CLAUDE.md: Step 8 done, Phase 4 complete.
```

### –ò–ù–°–¢–†–£–ö–¶–ò–Ø 9 (–®–∞–≥ 9: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è)

```
–§–∏–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Screen v2 + Pro v2.

1. app/main.py ‚Äî —É–±–µ–¥–∏—Å—å —á—Ç–æ screen webhook router –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω 
   (–æ–Ω —É–∂–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–µ—Ä–µ–∑ create_webhook_router –≤ —Ü–∏–∫–ª–µ –ø–æ bot_config)

2. scripts/set_webhooks.py ‚Äî —É–±–µ–¥–∏—Å—å screen –±–æ—Ç –≤–∫–ª—é—á—ë–Ω

3. requirements.txt ‚Äî –ø—Ä–æ–≤–µ—Ä—å —á—Ç–æ python-docx –µ—Å—Ç—å (—É–∂–µ –µ—Å—Ç—å: python-docx==1.1.2)

4. –ü—Ä–æ–≤–µ—Ä—å –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

5. –°–æ–∑–¥–∞–π —Ç–µ—Å—Ç: scripts/test_screen_flow.py
   - –°–æ–∑–¥–∞—ë—Ç assessment —á–µ—Ä–µ–∑ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –≤ –ë–î
   - –°–∏–º—É–ª–∏—Ä—É–µ—Ç 6 –æ—Ç–≤–µ—Ç–æ–≤ Phase 1
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –æ—Ç—á—ë—Ç–∞
   
6. –û–±–Ω–æ–≤–∏ CLAUDE.md:
   - Phase 4: COMPLETE (5/5 –±–æ—Ç–æ–≤ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã)
   - –î–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ Screen v2 –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
   - –û–±–Ω–æ–≤–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ñ–∞–π–ª–æ–≤
   - –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: Phase 5 (AI Integration polish)
```

---

## 6. –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

| –†–∏—Å–∫ | –ú–∏—Ç–∏–≥–∞—Ü–∏—è |
|------|-----------|
| Claude –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON | Fallback: –ø–æ–≤—Ç–æ—Ä —Å temperature=0, –∑–∞—Ç–µ–º default response |
| Confidence –Ω–µ –¥–æ—Å—Ç–∏–≥–∞–µ—Ç 0.85 | Phase 3 –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø–æ—Å–ª–µ max –≤–æ–ø—Ä–æ—Å–æ–≤ |
| –ë–æ–ª—å—à–æ–π payload –≤ state_payload | JSONB –≤ Supabase –≤—ã–¥–µ—Ä–∂–∏—Ç, –Ω–æ response_history –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å 50 –∑–∞–ø–∏—Å—è–º–∏ |
| DOCX –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞ Railway | python-docx —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ GUI, –ø—Ä–æ–±–ª–µ–º –Ω–µ –±—É–¥–µ—Ç |
| Multi-select callback flood | Debounce —á–µ—Ä–µ–∑ toggle –≤ payload, –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ "–ì–æ—Ç–æ–≤–æ" |

---

## 7. –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏

| –®–∞–≥ | –û—Ü–µ–Ω–∫–∞ |
|-----|--------|
| 1. –ú–æ–¥–µ–ª—å –ë–î | 15 –º–∏–Ω |
| 2. –î–≤–∏–∂–æ–∫ | 45 –º–∏–Ω |
| 3. –ë–∞–Ω–∫ –≤–æ–ø—Ä–æ—Å–æ–≤ | 30 –º–∏–Ω |
| 4. –ü—Ä–æ–º–ø—Ç—ã | 30 –º–∏–Ω |
| 5. –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä | 60 –º–∏–Ω |
| 6. –û—Ç—á—ë—Ç | 45 –º–∏–Ω |
| 7. Webhook Screen | 60 –º–∏–Ω |
| 8. Pro v2 | 45 –º–∏–Ω |
| 9. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è | 30 –º–∏–Ω |
| **–ò—Ç–æ–≥–æ** | **~6 —á–∞—Å–æ–≤** |
