"""Три встроенных кейса PsycheOS Simulator."""

from app.services.simulator.schemas import (
    BuiltinCase, ClientInfo, ScreenProfile, ContinuumScore,
    Layers, LayerDescription, Conceptualization, LayerA, LayerB, LayerC,
    SystemCost, Target, CaseDynamics, CrisisFlag,
)

# ═══════════════════════════════════════════════════════════════════════════
# КЕЙС 1: СТРУКТУРИРОВАННЫЙ НЕВРОТИЧЕСКИЙ КОНФЛИКТ
# ═══════════════════════════════════════════════════════════════════════════

CASE_1 = BuiltinCase(
    case_id="CASE_01_NEUROTIC",
    case_name="Структурированный невротический конфликт",
    difficulty="MEDIUM",

    client=ClientInfo(
        id="SIM-NC-01",
        gender="male",
        age=34,
        presenting_complaints=[
            "Хроническая тревога перед принятием решений",
            "Прокрастинация при карьерных возможностях",
            "Ощущение «застревания» при хороших условиях",
            "Напряжение в плечах, бессонница перед важными встречами",
        ],
    ),

    screen_profile=ScreenProfile(
        economy_exploration=ContinuumScore(value=32, variability="low", rigidity=True),
        protection_contact=ContinuumScore(value=45, variability="moderate", rigidity=False),
        retention_movement=ContinuumScore(value=28, variability="low", rigidity=True),
        survival_development=ContinuumScore(value=38, variability="moderate", rigidity=False),
        tension_zones=[
            "economy_exploration: ригидная экономия, отказ от новых возможностей",
            "retention_movement: сильное удержание, невозможность отпустить текущую форму",
        ],
        rigidity_flags=["economy_exploration", "retention_movement"],
    ),

    layers=Layers(
        L0=LayerDescription(
            description="Умеренная вегетативная реактивность. Мышечное напряжение (плечи, шея). Ситуативная бессонница. Телесное «замирание» при необходимости действовать.",
            key_markers=["мышечное напряжение", "ситуативная бессонница", "замирание"],
            triggers=["дедлайн", "новая роль", "публичное выступление"],
        ),
        L1=LayerDescription(
            description="Откладывание. Переключение на рутину. Избегание выбора. Поиск «ещё информации» перед решением.",
            key_markers=["прокрастинация", "псевдо-подготовка", "уход в рутину"],
            triggers=["момент выбора", "неструктурированная задача"],
        ),
        L2=LayerDescription(
            description="Мощная стратегия минимизации риска через отсрочку. «Сначала нужно всё продумать». Перфекционизм как контроль. Развитая рационализация — убедительно объясняет любое избегание.",
            key_markers=["перфекционизм", "рационализация отсрочки", "катастрофизация ошибки"],
            triggers=["ситуация без гарантированного исхода"],
        ),
        L3=LayerDescription(
            description="Идентичность «компетентного и надёжного». «Если провалюсь — я не тот, за кого себя выдаю». Скрытый синдром самозванца. Доступен при аккуратной работе.",
            key_markers=["синдром самозванца", "страх разоблачения", "условная ценность"],
            triggers=["публичная оценка", "сравнение с другими"],
        ),
        L4=LayerDescription(
            description="Мир требует безошибочности. Опыт родителя, ценившего результат, а не процесс. Ошибка = утрата принадлежности.",
            key_markers=["условная ценность", "ошибка = отвержение"],
            triggers=["ситуации с видимой ошибкой"],
        ),
    ),

    conceptualization=Conceptualization(
        layer_a=LayerA(
            leading_hypothesis="Система поддерживает отсрочку и минимизацию риска, чтобы защитить идентичность «компетентного» и избежать ошибки, субъективно равной утрате принадлежности. Прокрастинация — не лень, а защита от катастрофы разоблачения.",
            dominant_layer="L3",
            configuration="Угроза оценки → L3 «могу оказаться некомпетентным» → L0 замирание → L1 откладывание → L2 рационализирует → риск снижен → L3 стабилизирована → цикл закреплён → возможность упущена → подтверждение L4",
            system_cost=SystemCost(
                energetic="Хроническое напряжение. Энергия на готовность к угрозе оценки. Мало ресурсов для творчества.",
                social="Надёжный, но не инициативный. Упускает возможности. Формальные отношения с руководством.",
                semantic="Ошибка ≠ обучение. Развитие блокировано. Смысл деятельности = «не провалиться».",
            ),
        ),
        layer_b=LayerB(
            targets=[
                Target(level="L0", description="Снижение телесной мобилизации при ситуациях оценки. Работа с замиранием."),
                Target(level="interface_L1_L0", description="Удлинение паузы между тревогой и автоматическим откладыванием."),
                Target(level="L2", description="От «минимизировать риск» к «допустить несовершенное действие»."),
                Target(level="L3", description="Компетентность ≠ безошибочность. Разделение идентичности и результата."),
                Target(level="L4", description="Ошибка как часть развития, а не условие отвержения."),
            ],
            sequence="L0 + interface L1-L0 → параллельно L2 → L3 после укрепления L0-L2 → L4 завершающий этап",
            transition_criterion="Способность удерживать тревогу оценки без замирания и откладывания.",
        ),
        layer_c=LayerC(
            metaphor="Шахматист, который боится сделать ход",
            narrative="Вы как шахматист — видите доску, знаете фигуры, продумываете на много ходов. Но момент двинуть фигуру — рука замирает. Один неверный ход, и вы не гроссмейстер, а самозванец. Поэтому ещё одна книга, ещё один анализ. А часы тикают. И парадокс: не ходить — это тоже ход. Только худший.",
            change_direction="Становится возможным сделать ход, не зная исхода. И обнаружить, что проигранная партия не стирает вас с доски.",
        ),
    ),

    dynamics=CaseDynamics(
        baseline_tension_L0=35,
        baseline_cognitive_access=72,
        baseline_uncertainty=55,
        baseline_trust=30,
        L0_reactivity="moderate",
        L2_strength="high",
        L3_accessibility="high",
        interpretation_tolerance="moderate",
        uncertainty_tolerance="moderate",
        cognitive_window="wide",
        escalation_speed="slow",
        intervention_range="wide",
        recovery_rate=0.7,
        volatility=0.2,
    ),

    crisis_flag=CrisisFlag.NONE,

    sensitive_zones=[
        "Прямое указание на страх ошибки → усиление рационализации L2, отстранение",
        "Сравнение с успешными → активация L3, рост tension_L0",
        "Вопросы про родителя (L4) → преждевременно: интеллектуализация или блокировка",
        "«Просто попробуйте» → обесценивание сложности, рост защит",
    ],

    predicted_error_trajectory={
        "premature_L3": "Работа с идентичностью без стабилизации L0 → интеллектуализация → иллюзия прогресса → при нажиме: рост tension_L0 → замирание → обрыв контакта",
        "direct_confrontation": "«Вы избегаете» → L3 угроза → рационализация усиливается → «мне действительно нужно больше данных» → потеря контакта",
        "empathy_without_structure": "Много поддержки без направления → комфорт → стагнация → фрустрация специалиста → давление → каскад",
        "ignoring_somatic": "Только когнитивная работа → тело замирает → инсайты не закрепляются → рецидив при реальной оценке",
    },
)


# ═══════════════════════════════════════════════════════════════════════════
# КЕЙС 2: ХРОНИЧЕСКАЯ РЕГУЛЯТОРНАЯ НЕСТАБИЛЬНОСТЬ
# ═══════════════════════════════════════════════════════════════════════════

CASE_2 = BuiltinCase(
    case_id="CASE_02_INSTABILITY",
    case_name="Хроническая регуляторная нестабильность",
    difficulty="HIGH",

    client=ClientInfo(
        id="SIM-RI-02",
        gender="female",
        age=29,
        presenting_complaints=[
            "Эмоциональная нестабильность в близких отношениях",
            "Страх быть покинутой",
            "Колебания между идеализацией и обесцениванием партнёра",
            "Импульсивные сообщения после конфликтов",
            "Сильная тревога при паузах в общении",
        ],
    ),

    screen_profile=ScreenProfile(
        economy_exploration=ContinuumScore(value=68, variability="high", rigidity=False),
        protection_contact=ContinuumScore(value=53, variability="low", rigidity=True),
        retention_movement=ContinuumScore(value=65, variability="moderate", rigidity=False),
        survival_development=ContinuumScore(value=74, variability="moderate", rigidity=False),
        tension_zones=[
            "protection_contact: ригидный защитный паттерн, недоверие в контактах",
        ],
        rigidity_flags=["protection_contact"],
    ),

    layers=Layers(
        L0=LayerDescription(
            description="ВЫСОКАЯ вегетативная реактивность. Тахикардия, спазм в животе при неопределённости. Нарушения сна. Быстрые скачки от гипервозбуждения к истощению.",
            key_markers=["тахикардия", "абдоминальный спазм", "инсомния", "скачки возбуждение-истощение"],
            triggers=["задержка ответа от партнёра", "пауза в общении", "неопределённость"],
        ),
        L1=LayerDescription(
            description="Проверка телефона, импульсивные звонки, эмоциональные вспышки. Быстрый flip привязанность → агрессия. Действия опережают осмысление.",
            key_markers=["импульсивный контакт", "flip привязанность-агрессия", "действие до мысли"],
            triggers=["молчание > 30 минут", "неоднозначное сообщение"],
        ),
        L2=LayerDescription(
            description="Стратегия гиперконтроля связи. «Если не держать — бросят». Чёрно-белое мышление. Стратегии СЛАБО структурированы — легко разрушаются под давлением аффекта.",
            key_markers=["гиперконтроль связи", "расщепление", "хрупкие стратегии"],
            triggers=["любой сигнал дистанции"],
        ),
        L3=LayerDescription(
            description="СЛАБО дифференцированная идентичность. Зависит от подтверждения через другого. «Отдаляется — я не ценна». L3 легко захлёстывается аффектом.",
            key_markers=["зависимая идентичность", "условная ценность", "хрупкая рефлексия"],
            triggers=["отсутствие подтверждения", "реальное или мнимое отвержение"],
        ),
        L4=LayerDescription(
            description="Страх утраты связи как угрозы существованию. Эмоционально нестабильная мать в детстве. Связь = существование.",
            key_markers=["экзистенциальный страх утраты", "нестабильная ранняя привязанность"],
            triggers=["ситуации, напоминающие покинутость"],
        ),
    ),

    conceptualization=Conceptualization(
        layer_a=LayerA(
            leading_hypothesis="Система поддерживает гиперчувствительность и импульсивный контакт для предотвращения утраты привязанности. Паттерн защищает идентичность и поддерживает ощущение существования через подтверждённую связь.",
            dominant_layer="L4",
            configuration="Дистанция → L4 «угроза существования» → L3 «брошена» → L0 гиперактивация → истощение → L1 импульсивный контакт → L2 «я контролирую связь» → краткое подтверждение → L4 восстановлен → цикл закреплён",
            system_cost=SystemCost(
                energetic="Хроническая гиперактивация. Бессонница, тахикардия, истощение кортизола.",
                social="Отношения = регуляция идентичности. Импульсивность = давление на партнёра → дистанцирование → подтверждение страха.",
                semantic="Закрыта автономная идентичность. Одиночество невозможно как ресурс. Интимность заменена выживанием.",
            ),
        ),
        layer_b=LayerB(
            targets=[
                Target(level="L0", description="Снижение симпатической гипервозбудимости при триггерах отвержения."),
                Target(level="interface_L1_L0", description="Удлинение латентного периода между сигналом и мобилизацией."),
                Target(level="L2", description="«Дистанция ≠ утрата». Пересборка стратегии."),
                Target(level="L3", description="Отделение ценности от исхода взаимодействия."),
                Target(level="L4", description="Связь как опыт, а не условие существования."),
            ],
            sequence="L0 + interface L1-L0 → параллельно L2 → L3 после укрепления L1-L2 → L4 завершающий",
            transition_criterion="Способность удерживать паузу при триггере без автоматической мобилизации.",
        ),
        layer_c=LayerC(
            metaphor="Маяк, который боится потухнуть",
            narrative="Вы как маяк на скале — светите, чтобы корабли знали о вашем существовании. Если свет поблёкнет — уплывут, и вы в полной тьме. Поэтому ярче, отчаяннее. Ловите каждый силуэт: «Я здесь, не уходи». Вы существуете только через отражение в чужих глазах.",
            change_direction="Маяк существует сам по себе — даже когда никто не смотрит.",
        ),
    ),

    dynamics=CaseDynamics(
        baseline_tension_L0=55,
        baseline_cognitive_access=45,
        baseline_uncertainty=72,
        baseline_trust=22,
        L0_reactivity="high",
        L2_strength="low",
        L3_accessibility="low",
        interpretation_tolerance="low",
        uncertainty_tolerance="low",
        cognitive_window="moderate",
        escalation_speed="fast",
        intervention_range="moderate",
        recovery_rate=0.4,
        volatility=0.8,
    ),

    crisis_flag=CrisisFlag.MODERATE,

    sensitive_zones=[
        "Любой намёк на дистанцию от специалиста → повторение паттерна, активация L4",
        "Пауза специалиста > 1 реплики → триггер L0",
        "«Вы боитесь быть одна» → преждевременная L4, риск дезорганизации",
        "Работа с гневом на мать → только после прочной стабилизации L0-L2",
        "Конфронтация импульсивности → воспринимается как отвержение",
    ],

    predicted_error_trajectory={
        "premature_L4": "Интерпретация связи с матерью → L4 активация → дезорганизация → импульсивная реакция (плач, агрессия, уход) → «меня не выдерживают»",
        "emotional_distance": "Нейтральная позиция → безразличие → L3-L4 активация → проверка связи через эскалацию → каскад",
        "confrontation_splitting": "«Вы видите чёрно-белое» → атака на единственную стратегию → агрессия → расщепление усиливается",
        "rushing_autonomy": "Автономная идентичность без стабилизации L0 → интеллектуальное согласие → тело паникует → триггер → полный откат",
    },
)


# ═══════════════════════════════════════════════════════════════════════════
# КЕЙС 3: КРИЗИСНАЯ КОНФИГУРАЦИЯ
# ═══════════════════════════════════════════════════════════════════════════

CASE_3 = BuiltinCase(
    case_id="CASE_03_CRISIS",
    case_name="Кризисная конфигурация",
    difficulty="VERY_HIGH",

    client=ClientInfo(
        id="SIM-CR-03",
        gender="male",
        age=41,
        presenting_complaints=[
            "Острая дезориентация после увольнения",
            "Невозможность планировать даже на день",
            "Пробуждения в 4 утра с тревогой",
            "Потеря аппетита, снижение веса",
            "«Всё рухнуло», «не знаю кто я без работы»",
            "Мысли «зачем всё это» (без суицидальных планов)",
        ],
    ),

    screen_profile=ScreenProfile(
        economy_exploration=ContinuumScore(value=18, variability="low", rigidity=True),
        protection_contact=ContinuumScore(value=22, variability="low", rigidity=True),
        retention_movement=ContinuumScore(value=15, variability="low", rigidity=True),
        survival_development=ContinuumScore(value=12, variability="low", rigidity=True),
        tension_zones=[
            "ВСЕ континуумы: тотальное смещение к выживанию, ригидность по всем осям",
        ],
        rigidity_flags=["economy_exploration", "protection_contact", "retention_movement", "survival_development"],
    ),

    layers=Layers(
        L0=LayerDescription(
            description="Выраженная дисрегуляция. Ранние пробуждения 4:00 с тахикардией. Анорексия. Генерализованное напряжение. Оцепенение. Когнитивный туман.",
            key_markers=["ранние пробуждения", "анорексия", "генерализованное напряжение", "оцепенение", "туман"],
            triggers=["утро", "любое решение", "вопрос «что дальше»"],
        ),
        L1=LayerDescription(
            description="Хаотичное переключение активность ↔ замирание. Попытки плана → бросает. Бесцельный скроллинг. Курение ↑. Избегание звонков.",
            key_markers=["хаотичность", "бросание начатого", "скроллинг", "избегание контакта"],
            triggers=["задача с планированием"],
        ),
        L2=LayerDescription(
            description="Стратегии РАЗРУШЕНЫ. «Работай больше» неприменимо. Новых нет. Попытки старых → провал. Руминация.",
            key_markers=["руминация", "неприменимость стратегий", "когнитивный тупик"],
            triggers=["попытка «взять себя в руки»"],
        ),
        L3=LayerDescription(
            description="Кризис идентичности. «Был руководителем — теперь никто». Профроль = вся идентичность. Стыд перед семьёй. НЕДОСТУПЕН — любое обращение к L3 усиливает кризис.",
            key_markers=["кризис идентичности", "слияние с ролью", "стыд", "обрушение самооценки"],
            triggers=["«чем занимаешься»", "бывшие коллеги"],
        ),
        L4=LayerDescription(
            description="Смысловой вакуум. Работа = способ существовать. Без неё — пустота. «Зачем всё это» — не суицидальность, а утрата рамки.",
            key_markers=["смысловой вакуум", "экзистенциальная пустота"],
            triggers=["свободное время", "выходные", "вечера"],
        ),
    ),

    conceptualization=Conceptualization(
        layer_a=LayerA(
            leading_hypothesis="Система потеряла центральный организующий элемент (профроль), обеспечивавший регуляцию на всех уровнях. Кризис не в потере работы, а в обрушении всей архитектуры управления, выстроенной вокруг одного элемента.",
            dominant_layer="L4",
            configuration="Утрата смыслового центра (L4) → обрушение идентичности (L3) → стратегии неприменимы (L2) → хаотичность (L1) → вегетативная дисрегуляция (L0) → попытки восстановить L2 старым → провал → усиление L4 → кризисный цикл",
            system_cost=SystemCost(
                energetic="КРИТИЧЕСКАЯ. Сон, питание, вегетатика нарушены. Аварийный режим.",
                social="Изоляция. Стыд блокирует контакт. Семья = давление. Коллеги = триггер стыда.",
                semantic="Полный вакуум. Старая модель разрушена, новая не создана. Горизонт = часы.",
            ),
        ),
        layer_b=LayerB(
            targets=[
                Target(level="L0", description="ПРИОРИТЕТ. Сон, питание, снижение напряжения. Без этого ничего невозможно."),
                Target(level="L1", description="Минимальная структура: опорные точки дня. Не план — ритм."),
                Target(level="L2", description="НЕ пересборка. Временные стратегии-заглушки: «на сегодня одно действие»."),
                Target(level="L3", description="ТОЛЬКО после L0-L2. Осторожно. Рано = углубление кризиса."),
                Target(level="L4", description="Финальный. Новая смысловая рамка. Не «найти работу» — перестроить модель ценности."),
            ],
            sequence="СТРОГО последовательно. L0 первый. L1 параллельно. L2 после устойчивого L0. L3/L4 — категорически не ранее стабилизации L0-L1.",
            transition_criterion="L0: сон > 5ч, питание. L1: 2-3 опорных точки дня. L2: снижение руминации, одно действие в день.",
        ),
        layer_c=LayerC(
            metaphor="Дом после землетрясения",
            narrative="Вы жили в доме из одного материала — работы. Землетрясение. Обломки. Не понять, где земля, где небо. Первая мысль — восстановить. Но руки не слушаются. Сейчас задача не строить. Задача — найти, где стоять.",
            change_direction="Фундамент — не работа. Фундамент — вы. На нём можно построить разное.",
        ),
    ),

    dynamics=CaseDynamics(
        baseline_tension_L0=78,
        baseline_cognitive_access=22,
        baseline_uncertainty=85,
        baseline_trust=18,
        L0_reactivity="high",
        L2_strength="low",
        L3_accessibility="low",
        interpretation_tolerance="low",
        uncertainty_tolerance="low",
        cognitive_window="narrow",
        escalation_speed="fast",
        intervention_range="narrow",
        recovery_rate=0.25,
        volatility=0.5,
    ),

    crisis_flag=CrisisFlag.HIGH,

    sensitive_zones=[
        "КРИТИЧНО: «зачем всё это» — НЕ суицидальность, но зона высокой чувствительности",
        "Любые вопросы про будущее — паралич или паника",
        "«Всё будет хорошо» — обесценивание, рост изоляции",
        "«Расскажите о работе» — L3 стыд + L4 пустота одновременно",
        "Когнитивные техники — невозможны при текущем L0, вызывают фрустрацию",
        "Домашние задания — система не способна, провал усиливает кризис",
    ],

    predicted_error_trajectory={
        "premature_cognitive": "«Посмотрите иначе» → не может (cognitive_access < 25) → «я даже думать не могу» → усиление L4",
        "future_orientation": "«Что хотите дальше» → паралич → tension_L0 ↑ → оцепенение → «не понимает, я не могу на завтра думать»",
        "reassurance": "«Вы справитесь» → обесценивание → «не понимает» → изоляция → trust ↓ → уход",
        "identity_too_early": "«Вы — не только работа» → утрата последнего значимого → экзистенциальная паника → каскад S4",
        "homework": "Задание (резюме, звонки) → не выполняет → стыд → «даже это не могу» → спираль → обрыв терапии",
    },
)


# ── Реестр кейсов ──────────────────────────────────────────────────────────

BUILTIN_CASES: dict[str, BuiltinCase] = {
    "1": CASE_1,
    "2": CASE_2,
    "3": CASE_3,
}
