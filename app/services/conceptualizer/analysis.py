"""Async hypothesis extraction using Claude API."""
import json
import logging

from anthropic import AsyncAnthropic

from app.config import settings

from .enums import ConfidenceLevel, HypothesisType, PsycheLevelEnum
from .models import Hypothesis, SessionState

logger = logging.getLogger(__name__)

_ANTHROPIC_MODEL = "claude-sonnet-4-5-20250929"

_EXTRACT_HYPOTHESIS_PROMPT = """\
–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø—Å–∏—Ö–æ—Ç–µ—Ä–∞–ø–µ–≤—Ç–∏—á–µ—Å–∫–∏—Ö –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª–∏–∑–∞—Ü–∏–π –≤ —Ä–∞–º–∫–∞—Ö PsycheOS framework.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –∏–∑–≤–ª–µ—á—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≥–∏–ø–æ—Ç–µ–∑—É –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞.

# PsycheOS Framework (–∫—Ä–∞—Ç–∫–æ)

## –°–ª–æ–∏ (L0-L4):
- L0: –ë–∞–∑–æ–≤–∞—è —Ä–µ–≥—É–ª—è—Ü–∏—è (—ç–Ω–µ—Ä–≥–∏—è, —Å–æ–Ω, —Ç–µ–ª–æ, –≤–∏—Ç–∞–ª—å–Ω–æ—Å—Ç—å)
- L1: –†–µ—Ñ–ª–µ–∫—Å–∏–≤–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–º—ã, –ø—Ä–∏–≤—ã—á–∫–∏, –∑–∞—â–∏—Ç—ã)
- L2: –°–æ–∑–Ω–∞—Ç–µ–ª—å–Ω—ã–π –≤—ã–±–æ—Ä (–ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è —Ä–µ–≥—É–ª—è—Ü–∏—è, —Ä–µ—à–µ–Ω–∏—è)
- L3: –°–æ—Ü–∏–∞–ª—å–Ω–æ-—Ä–æ–ª–µ–≤–æ–π –∫–æ–Ω—Ç—Ä–æ–ª—å (–æ—Ç–Ω–æ—à–µ–Ω–∏—è, —Ä–æ–ª–∏, —Å–æ—Ü–∏–∞–ª—å–Ω–∞—è –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å)
- L4: –°–º—ã—Å–ª—ã –∏ –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å (—Ü–µ–Ω–Ω–æ—Å—Ç–∏, –Ω–∞—Ä—Ä–∞—Ç–∏–≤, "–∫—Ç–æ —è")

## –¢–∏–ø—ã –≥–∏–ø–æ—Ç–µ–∑ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û –†–ê–ó–õ–ò–ß–ê–¢–¨):

### MANAGERIAL (üéØ –ü–†–ò–û–†–ò–¢–ï–¢)
**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –û–ø–∏—Å—ã–≤–∞–µ—Ç –ì–î–ï –∏ –ö–ê–ö –º–æ–∂–Ω–æ –≤–ª–∏—è—Ç—å
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "—Å—Ç–æ–∏—Ç", "–Ω–∞—á–∞—Ç—å —Å", "–≤–º–µ—à–∞—Ç—å—Å—è", "–≤–æ–∑–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å"
- –£–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –¢–û–ß–ö–£ –£–ü–†–ê–í–õ–ï–ù–ò–Ø, leverage point
- –ì–æ–≤–æ—Ä–∏—Ç —á—Ç–æ "–º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å—Å—è", "–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å"
- –ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –¥–µ–π—Å—Ç–≤–∏–π

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–°—Ç–æ–∏—Ç –Ω–∞—á–∞—Ç—å —Å L0 - —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–Ω"
- "–ú–æ–∂–Ω–æ –≤–º–µ—à–∞—Ç—å—Å—è –≤ –∑–∞–∑–æ—Ä –º–µ–∂–¥—É L3 –∏ L0"
- "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞ - –ø–µ—Ä–µ—Ö–æ–¥ L3 ‚Üí L0, –∑–¥–µ—Å—å –º–æ–∂–Ω–æ –≤–ª–∏—è—Ç—å"

### DYNAMIC
**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –û–ø–∏—Å—ã–≤–∞–µ—Ç –ú–ï–•–ê–ù–ò–ó–ú–´ –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –≤–æ –≤—Ä–µ–º–µ–Ω–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: "–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è", "–ø–µ—Ç–ª—è", "—Ü–∏–∫–ª", "–ø–æ–¥–∫—Ä–µ–ø–ª—è–µ—Ç—Å—è"
- –û–±—ä—è—Å–Ω—è–µ—Ç –ü–û–ß–ï–ú–£ –ø–∞—Ç—Ç–µ—Ä–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è
- –°—Ç—Ä–µ–ª–∫–∏ –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: A ‚Üí B ‚Üí C

**–ü—Ä–∏–º–µ—Ä—ã:**
- "L3 —Ç—Ä–µ–±—É–µ—Ç ‚Üí L0 –º–æ–±–∏–ª–∏–∑—É–µ—Ç—Å—è ‚Üí –∏—Å—Ç–æ—â–µ–Ω–∏–µ ‚Üí –∏–∑–±–µ–≥–∞–Ω–∏–µ ‚Üí –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ"
- "–ü–µ—Ç–ª—è: —Ç—Ä–µ–≤–æ–≥–∞ ‚Üí –∏–∑–±–µ–≥–∞–Ω–∏–µ ‚Üí –∫—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ–µ –æ–±–ª–µ–≥—á–µ–Ω–∏–µ ‚Üí —É—Å–∏–ª–µ–Ω–∏–µ"

### FUNCTIONAL
**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –û–ø–∏—Å—ã–≤–∞–µ—Ç –ß–¢–û —Å–∏—Å—Ç–µ–º–∞ –ø–æ–ª—É—á–∞–µ—Ç –æ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: "–∑–∞—â–∏—â–∞–µ—Ç", "–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç", "—Å–ª—É–∂–∏—Ç –¥–ª—è", "—Ñ—É–Ω–∫—Ü–∏—è"
- –û–±—ä—è—Å–Ω—è–µ—Ç –ó–ê–ß–ï–ú —Å–∏—Å—Ç–µ–º–∞ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–ü–∞—Ç—Ç–µ—Ä–Ω –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –æ—Å–æ–∑–Ω–∞–Ω–∏—è —É—Ç—Ä–∞—Ç—ã"
- "–ò–∑–±–µ–≥–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∞—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π –∫–æ–ª–ª–∞–ø—Å"

### STRUCTURAL
**–ü—Ä–∏–∑–Ω–∞–∫–∏:**
- –û–ø–∏—Å—ã–≤–∞–µ—Ç –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Æ —Å–∏—Å—Ç–µ–º—ã
- –ö–æ–Ω—Å—Ç–∞—Ç–∏—Ä—É–µ—Ç –ö–ê–ö —É—Å—Ç—Ä–æ–µ–Ω–æ (–±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –∑–∞—á–µ–º –∏–ª–∏ –∫–∞–∫ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
- –û–ø–∏—Å–∞—Ç–µ–ª—å–Ω–∞—è, –Ω–µ –æ–±—ä—è—Å–Ω—è—é—â–∞—è

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–°–∏—Å—Ç–µ–º–∞ –≤ —Ä–µ–∂–∏–º–µ –≤—ã–∂–∏–≤–∞–Ω–∏—è —Å —Ä–∏–≥–∏–¥–Ω–æ–π –∑–∞—â–∏—Ç–æ–π"
- "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: L0 –∏—Å—Ç–æ—â—ë–Ω, L1 –≥–∏–ø–µ—Ä–∞–∫—Ç–∏–≤–µ–Ω"

# –ê–õ–ì–û–†–ò–¢–ú –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–ò

1. –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "—Å—Ç–æ–∏—Ç", "–≤–º–µ—à–∞—Ç—å—Å—è", "–≤–ª–∏—è—Ç—å", "–Ω–∞—á–∞—Ç—å —Å", "–∏–∑–º–µ–Ω–∏—Ç—å" ‚Üí **–ü–†–û–í–ï–†–ò–¢–¨: —ç—Ç–æ MANAGERIAL?**
2. –ï—Å–ª–∏ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø–µ—Ç–ª–∏, —Å—Ç—Ä–µ–ª–∫–∏ A‚ÜíB‚ÜíC, –º–µ—Ö–∞–Ω–∏–∑–º—ã ‚Üí DYNAMIC
3. –ï—Å–ª–∏ –æ–±—ä—è—Å–Ω—è–µ—Ç –∑–∞—á–µ–º, —Ñ—É–Ω–∫—Ü–∏—é, —á—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç ‚Üí FUNCTIONAL
4. –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é ‚Üí STRUCTURAL

# –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ (—Å—Ç—Ä–æ–≥–æ JSON):

{
  "type": "managerial|dynamic|functional|structural",
  "levels": ["L0", "L1", ...],
  "formulation": "–∫—Ä–∞—Ç–∫–∞—è —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)",
  "confidence": "weak|working|dominant",
  "reasoning": "–ø–æ—á–µ–º—É –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ç–∏–ø"
}

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏–µ –ù–ê –ß–¢–û –ú–û–ñ–ù–û –í–õ–ò–Ø–¢–¨ –∏–ª–∏ –ß–¢–û –ò–ó–ú–ï–ù–ò–¢–¨ - —ç—Ç–æ MANAGERIAL!

–û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –¢–û–õ–¨–ö–û JSON, –ë–ï–ó –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û–ì–û –¢–ï–ö–°–¢–ê.\
"""


def _post_process_type(formulation: str, extracted_type: str) -> str:
    """Override to managerial if 2+ managerial markers found in formulation."""
    markers = [
        "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "—Å—Ç–æ–∏—Ç", "–Ω–∞—á–∞—Ç—å —Å", "–≤–º–µ—à–∞—Ç—å—Å—è",
        "–≤–æ–∑–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å", "–≤–ª–∏—è—Ç—å", "–∏–∑–º–µ–Ω–∏—Ç—å", "—Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
        "—Ä–∞–±–æ—Ç–∞—Ç—å —Å", "—Ñ–æ–∫—É—Å –Ω–∞", "–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç", "–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è —Ç–æ—á–∫–∞",
        "—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è", "leverage",
    ]
    fl = formulation.lower()
    count = sum(1 for m in markers if m in fl)
    if count >= 2 and extracted_type != "managerial":
        logger.warning(
            f"[conceptualizator] Type override: '{extracted_type}' ‚Üí 'managerial' "
            f"({count} managerial markers)"
        )
        return "managerial"
    return extracted_type


def _parse_json(text: str) -> dict:
    t = text.strip()
    if t.startswith("```json"):
        t = t[7:]
    if t.startswith("```"):
        t = t[3:]
    if t.endswith("```"):
        t = t[:-3]
    return json.loads(t.strip())


async def extract_hypothesis_from_response(
    message: str, session: SessionState
) -> Hypothesis:
    """Extract a structured hypothesis from the specialist's message using Claude."""
    user_message = (
        f"–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ—Å—Å–∏–∏:\n"
        f"- –¢–µ–∫—É—â–∏—Ö –≥–∏–ø–æ—Ç–µ–∑: {len(session.get_active_hypotheses())}\n"
        f"- –£–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏—Ö –≥–∏–ø–æ—Ç–µ–∑: {len(session.get_managerial_hypotheses())}\n"
        f"- –í–æ–ø—Ä–æ—Å–æ–≤ –∑–∞–¥–∞–Ω–æ: {session.progress.dialogue_turns}\n\n"
        f"–û—Ç–≤–µ—Ç —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞:\n{message}\n\n"
        "–ò–∑–≤–ª–µ–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –≥–∏–ø–æ—Ç–µ–∑—É –∏–∑ —ç—Ç–æ–≥–æ –æ—Ç–≤–µ—Ç–∞.\n"
        '–í–ê–ñ–ù–û: –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–∞ "–º–æ–∂–Ω–æ", "–Ω—É–∂–Ω–æ", "—Å—Ç–æ–∏—Ç", '
        '"–≤–º–µ—à–∞—Ç—å—Å—è" - —ç—Ç–æ MANAGERIAL!'
    )
    try:
        client = AsyncAnthropic(api_key=settings.ANTHROPIC_API_KEY)
        resp = await client.messages.create(
            model=_ANTHROPIC_MODEL,
            max_tokens=1000,
            system=_EXTRACT_HYPOTHESIS_PROMPT,
            messages=[{"role": "user", "content": user_message}],
        )
        data = _parse_json(resp.content[0].text)
        logger.debug(f"[conceptualizator] Claude hypothesis data: {data}")

        corrected_type = _post_process_type(data["formulation"], data["type"])
        data["type"] = corrected_type

        hyp_id = f"hyp_{session.progress.hypotheses_added + 1:03d}"
        return Hypothesis(
            id=hyp_id,
            type=HypothesisType(data["type"]),
            levels=[PsycheLevelEnum(lv) for lv in data["levels"]],
            formulation=data["formulation"],
            confidence=ConfidenceLevel(data["confidence"]),
            foundations=[data.get("reasoning", "")],
        )
    except Exception:
        logger.exception("[conceptualizator] Error extracting hypothesis; using fallback")
        return Hypothesis(
            id=f"hyp_{session.progress.hypotheses_added + 1:03d}",
            type=HypothesisType.STRUCTURAL,
            levels=[PsycheLevelEnum.L0],
            formulation=message[:300],
            confidence=ConfidenceLevel.WEAK,
            foundations=["Fallback extraction"],
        )
